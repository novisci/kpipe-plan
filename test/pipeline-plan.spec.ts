import { compileOps, parseOps } from '..'
import { renderOpList } from '../src/render'

test('compile plan with pipeline', () => {
  const ops = JSON.parse(require('fs').readFileSync('./test/pipeline-plan.json'))

  // console.error('IN', JSON.stringify(ops))
  /* eslint-disable-next-line @typescript-eslint/no-unused-vars */
  const [[...cops], { ...state }] = compileOps(parseOps(ops), {})
  // console.error('OUT', JSON.stringify(cops))

  renderOpList(cops)

  expect(JSON.stringify(cops))
    .toBe(JSON.stringify([['plan', 'Test pipeline', [['stage', 'Pipeline stage', [['spread', '', [['echo', 'pipe 0 - pre 00000'], ['echo', 'pipe 0 - pre 00004']]], ['spread', '', [['echo', 'pipe 0 - pre 1 00000'], ['echo', 'pipe 0 - pre 1 00004']]], ['spread', '', [['echo', 'pipe 0 - tasks 00000'], ['echo', 'pipe 0 - tasks 00004']]], ['spread', '', [['echo', 'pipe 0 - post 00000'], ['echo', 'pipe 0 - post 00004']]], ['spread', '', [['echo', 'pipe 1 - pre 00000'], ['echo', 'pipe 0 - pre 00001'], ['echo', 'pipe 1 - pre 00004'], ['echo', 'pipe 0 - pre 00008']]], ['spread', '', [['echo', 'pipe 0 - pre 1 00001'], ['echo', 'pipe 0 - pre 1 00008']]], ['spread', '', [['echo', 'pipe 1 - tasks 00000'], ['echo', 'pipe 0 - tasks 00001'], ['echo', 'pipe 1 - tasks 00004'], ['echo', 'pipe 0 - tasks 00008']]], ['spread', '', [['echo', 'pipe 1 - post 00000'], ['echo', 'pipe 0 - post 00001'], ['echo', 'pipe 1 - post 00004'], ['echo', 'pipe 0 - post 00008']]], ['spread', '', [['echo', 'pipe 2 - pre 00000'], ['echo', 'pipe 1 - pre 00001'], ['echo', 'pipe 0 - pre 00002'], ['echo', 'pipe 2 - pre 00004'], ['echo', 'pipe 0 - pre 00005'], ['echo', 'pipe 1 - pre 00008'], ['echo', 'pipe 0 - pre 00009']]], ['spread', '', [['echo', 'pipe 0 - pre 1 00002'], ['echo', 'pipe 0 - pre 1 00005'], ['echo', 'pipe 0 - pre 1 00009']]], ['spread', '', [['echo', 'pipe 2 - tasks 00000'], ['echo', 'pipe 1 - tasks 00001'], ['echo', 'pipe 0 - tasks 00002'], ['echo', 'pipe 2 - tasks 00004'], ['echo', 'pipe 0 - tasks 00005'], ['echo', 'pipe 1 - tasks 00008'], ['echo', 'pipe 0 - tasks 00009']]], ['spread', '', [['echo', 'pipe 2 - post 00000'], ['echo', 'pipe 1 - post 00001'], ['echo', 'pipe 0 - post 00002'], ['echo', 'pipe 2 - post 00004'], ['echo', 'pipe 0 - post 00005'], ['echo', 'pipe 1 - post 00008'], ['echo', 'pipe 0 - post 00009']]], ['spread', '', [['echo', 'pipe 3 - pre 00000'], ['echo', 'pipe 2 - pre 00001'], ['echo', 'pipe 1 - pre 00002'], ['echo', 'pipe 0 - pre 00003'], ['echo', 'pipe 3 - pre 00004'], ['echo', 'pipe 1 - pre 00005'], ['echo', 'pipe 0 - pre 00006'], ['echo', 'pipe 2 - pre 00008'], ['echo', 'pipe 1 - pre 00009']]], ['spread', '', [['echo', 'pipe 0 - pre 1 00003'], ['echo', 'pipe 0 - pre 1 00006']]], ['spread', '', [['echo', 'pipe 3 - tasks 00000'], ['echo', 'pipe 2 - tasks 00001'], ['echo', 'pipe 1 - tasks 00002'], ['echo', 'pipe 0 - tasks 00003'], ['echo', 'pipe 3 - tasks 00004'], ['echo', 'pipe 1 - tasks 00005'], ['echo', 'pipe 0 - tasks 00006'], ['echo', 'pipe 2 - tasks 00008'], ['echo', 'pipe 1 - tasks 00009']]], ['spread', '', [['echo', 'pipe 3 - post 00000'], ['echo', 'pipe 2 - post 00001'], ['echo', 'pipe 1 - post 00002'], ['echo', 'pipe 0 - post 00003'], ['echo', 'pipe 3 - post 00004'], ['echo', 'pipe 1 - post 00005'], ['echo', 'pipe 0 - post 00006'], ['echo', 'pipe 2 - post 00008'], ['echo', 'pipe 1 - post 00009']]], ['spread', '', [['echo', 'pipe 3 - post 1 00000'], ['echo', 'pipe 3 - post 1 00004']]], ['spread', '', [['echo', 'pipe 3 - pre 00001'], ['echo', 'pipe 2 - pre 00002'], ['echo', 'pipe 1 - pre 00003'], ['echo', 'pipe 2 - pre 00005'], ['echo', 'pipe 1 - pre 00006'], ['echo', 'pipe 0 - pre 00007'], ['echo', 'pipe 3 - pre 00008'], ['echo', 'pipe 2 - pre 00009']]], ['spread', '', [['echo', 'pipe 0 - pre 1 00007']]], ['spread', '', [['echo', 'pipe 3 - tasks 00001'], ['echo', 'pipe 2 - tasks 00002'], ['echo', 'pipe 1 - tasks 00003'], ['echo', 'pipe 2 - tasks 00005'], ['echo', 'pipe 1 - tasks 00006'], ['echo', 'pipe 0 - tasks 00007'], ['echo', 'pipe 3 - tasks 00008'], ['echo', 'pipe 2 - tasks 00009']]], ['spread', '', [['echo', 'pipe 3 - post 00001'], ['echo', 'pipe 2 - post 00002'], ['echo', 'pipe 1 - post 00003'], ['echo', 'pipe 2 - post 00005'], ['echo', 'pipe 1 - post 00006'], ['echo', 'pipe 0 - post 00007'], ['echo', 'pipe 3 - post 00008'], ['echo', 'pipe 2 - post 00009']]], ['spread', '', [['echo', 'pipe 3 - post 1 00001'], ['echo', 'pipe 3 - post 1 00008']]], ['spread', '', [['echo', 'pipe 3 - pre 00002'], ['echo', 'pipe 2 - pre 00003'], ['echo', 'pipe 3 - pre 00005'], ['echo', 'pipe 2 - pre 00006'], ['echo', 'pipe 1 - pre 00007'], ['echo', 'pipe 3 - pre 00009']]], ['spread', '', [['echo', 'pipe 3 - tasks 00002'], ['echo', 'pipe 2 - tasks 00003'], ['echo', 'pipe 3 - tasks 00005'], ['echo', 'pipe 2 - tasks 00006'], ['echo', 'pipe 1 - tasks 00007'], ['echo', 'pipe 3 - tasks 00009']]], ['spread', '', [['echo', 'pipe 3 - post 00002'], ['echo', 'pipe 2 - post 00003'], ['echo', 'pipe 3 - post 00005'], ['echo', 'pipe 2 - post 00006'], ['echo', 'pipe 1 - post 00007'], ['echo', 'pipe 3 - post 00009']]], ['spread', '', [['echo', 'pipe 3 - post 1 00002'], ['echo', 'pipe 3 - post 1 00005'], ['echo', 'pipe 3 - post 1 00009']]], ['spread', '', [['echo', 'pipe 3 - pre 00003'], ['echo', 'pipe 3 - pre 00006'], ['echo', 'pipe 2 - pre 00007']]], ['spread', '', [['echo', 'pipe 3 - tasks 00003'], ['echo', 'pipe 3 - tasks 00006'], ['echo', 'pipe 2 - tasks 00007']]], ['spread', '', [['echo', 'pipe 3 - post 00003'], ['echo', 'pipe 3 - post 00006'], ['echo', 'pipe 2 - post 00007']]], ['spread', '', [['echo', 'pipe 3 - post 1 00003'], ['echo', 'pipe 3 - post 1 00006']]], ['spread', '', [['echo', 'pipe 3 - pre 00007']]], ['spread', '', [['echo', 'pipe 3 - tasks 00007']]], ['spread', '', [['echo', 'pipe 3 - post 00007']]], ['spread', '', [['echo', 'pipe 3 - post 1 00007']]]]]]]]))
})
